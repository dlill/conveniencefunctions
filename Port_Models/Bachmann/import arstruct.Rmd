---
title: "Untitled"
author: "Daniel Lill"
date: "11 July 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dMod)
library(conveniencefunctions)
library(shiny)
library(miniUI)
```

```{r}
# library(R.matlab)
# d2dresult <- readMat(c("~/Promotion/Software/d2d/arFramework3/Examples/Bachmann_MSB2011/Results/BestFit/workspace.mat"))
# saveRDS(d2dresult, "workspaceMAT.rds")
d2dresult <- readRDS("workspaceMAT.rds")
```


The best way to explore the ar struct is to print out the structure, then find the dimensions which have length 1
```{r explore ar struct, eval=FALSE}
d2dresult$ar %>% dim # answer: 38 1 1

d2dresult$ar[,1,1] %>% # take only the first dimension
# names %>% 
  str1 %>%
  {.}

# Look at model
d2dresult$ar[,1,1][["model"]][,1,1] %>%  # is a list, since again the array was of dim 50 1 1
  str1 %>%
  {.}

d2dresult$ar[,1,1][["model"]][,1,1][["fp"]] %>% 
  # str1 %>%
  {.}


d2dresult$ar[,1,1][["model"]][,1,1][1:10] %>% # rather boring
  # str2 %>%
{.}

d2dresult$ar[,1,1][["model"]][,1,1][11:20] %>% # rather boring
  # str2 %>%
{.}

d2dresult$ar[,1,1][["model"]][,1,1][21:30] %>% # rather boring
  # str2 %>%
{.}

d2dresult$ar[,1,1][["model"]][,1,1][31:40] %>% # data is interesting
  # str2 %>%
{.}


d2dresult$ar[,1,1][["model"]][,1,1][["data"]][,1,] %>% # dim 70 (1) 42
  str1 %>% 
  {.}


d2dresult$ar[,1,1][["model"]][,1,1][["data"]][1,1,] %>% # last dimension is a realization of a condition
  str1 %>% 
  {.}

d2dresult$ar[,1,1][["model"]][,1,1][["data"]][,1,] %>% # elements of one condition
  dimnames() %>% 
  {.}


# look at one condition
d2dresult$ar[,1,1][["model"]][,1,1][["data"]][,1,1] %>% # elements of one condition
  # names %>% 
  str1 %>%
  # dim %>% 
  {.}
```


# Build ode model
```{r}
mymodel <- d2dresult$ar[,1,1][["model"]][,1,1] %>%  # is a list, since again the array was of dim 50 1 1
  # str1 %>%
  {.}
mymodel %>% str1
```

```{r odemodel}
states <- mymodel$xNames %>% unlist %>% unname()
comp <- mymodel$c %>% unlist() %>% unname()
comp_size <- mymodel$pc %>% unlist() %>% unname() %>% as.numeric()
state_comp <- mymodel$cLink[1,] %>% factor() %>% `levels<-`(comp)
states_df <- data.frame(state = states, compartment = state_comp, volumes = comp_size[state_comp], stringsAsFactors = F)

rates <- mymodel$fv %>% unlist() %>% unname()
N <- mymodel$N
rownames(N) <- states_df$state
N[N==0] <- NA

reactions <- eqnlist(smatrix = t(N), states = states_df$state, rates = rates, volumes = structure(states_df$volumes, names = states_df$state))

f <- odemodel(reactions, modelname = "arOdemodel")
x <- Xs(f)
```

```{r parameters global trafo}

# # all inner parameter names of the model
# # however, $pc is not the name of the parameter but the volume directly
# pvariables <- c("c", "u", "x", "x0")
# parnames <- map(pvariables %>% paste0("p",.) %>% setNames(.,.), function(myvar) mymodel[[myvar]] %>% unlist %>% unname)
# parnames$pc <- comp
# 
# fvariables <- c("p", "u", "v", "x")
# # map(fvariables %>% paste0("f",.) %>% setNames(.,.), function(myvar) mymodel[[myvar]] %>% unlist %>% unname)
# pareqns <- mymodel$fp %>% unlist %>% unname
# 
# # general trafo
# # order of mymodel$fp: c("pc", "px", "pu", "px0")
# inits <- parnames$px0 #%>% are_names_of(.,str_replace_all(.,"init_",""))
# parnames <- parnames[c("pc", "px", "pu", "px0")] %>% do.call(c,.) #%>% str_replace_all("^init_", "")
# 
# # fp(x0) are not of the same order as px0
# 
# 
# 
# trafo0 <-  pareqns %>% 
#   setNames(parnames)

parnames <- mymodel$p  %>% unlist %>% unname
pareqns  <- mymodel$fp %>% unlist %>% unname

# in parameter trafos, replacing "init_" by "" is not a problem, but they also appear in observation functions to normalize observations. Therefore, duplicate inits, once keeping init_ in the name, but filling both duplicates with the same value
init_ind <- parnames %>% str_detect("^init_")
init_names <- parnames[init_ind]
parnames <- parnames %>% str_replace_all("init_", "")
pareqns  <- pareqns  %>% str_replace_all("init_", "")
init_eqns <- pareqns[init_ind]

parnames <- c(parnames, init_names)
pareqns <- c(pareqns, init_eqns)


# compartment names are somehow already replaced by their values not very elegant, hardcoded and could result in problems for other models
parnames[1:length(comp)] <- comp

trafo0 <-  pareqns %>%
  setNames(parnames)

```


```{r}
mymodel[["data"]][,1,1] %>% 
  str1
  # names %>% sort

mymodel[["data"]][,1,] %>% 
  dimnames()
```


```{r condition}
i <- 1
mycondition <- mymodel[["data"]][,1,i]

# not very elegant
condname <- mycondition$name %>% unlist() %>% unname() %>% paste0( "_", i)
```

```{r}
start_letters <- mycondition %>% names() %>% str_sub(end = 1) %>% unique() %>% sort
```


```{r}
# mycondition[str_detect(names(mycondition), "^c")] %>% map(unlist) # not interesting
# mycondition[str_detect(names(mycondition), "^d")] %>% map(unlist) # not interesting
mycondition[str_detect(names(mycondition), "^f")] %>% map(unlist)
# mycondition[str_detect(names(mycondition), "^h")] %>% map(unlist)# not interesting
mycondition[str_detect(names(mycondition), "^l")] %>% map(unlist) # a bit interesting
mycondition[str_detect(names(mycondition), "^n")] %>% map(unlist) # a bit interesting
mycondition[str_detect(names(mycondition), "^p")] %>% map(unlist)
# mycondition[str_detect(names(mycondition), "^q")] %>% map(unlist) # not interesting
# mycondition[str_detect(names(mycondition), "^s")] %>% map(unlist) %>% name # not interesting, sensitiivities
mycondition[str_detect(names(mycondition), "^t")] %>% map(unlist) # time
mycondition[str_detect(names(mycondition), "^y")] %>% map(unlist) #%>% names
```

build observation function
```{r g and e cond}

y <- mycondition$y %>% unlist %>% unname

fy <- mycondition$fy %>% unlist %>% unname
obs <- fy %>% setNames(y)
g <- Y(obs, x, condition = condname, modelname = paste0("ar_g_", condname))
warning("write them out into .GlobalEnv when inside a loop to compile() them")


fystd <- mycondition$fystd %>% unlist() %>% unname()
errors <- fystd %>% setNames(y)
e <- Y(errors, (g*x), condition = condname, modelname = paste0("ar_e_", condname))


```

```{r p cond}
parnames <- mycondition$pold  %>% unlist %>% unname
pareqns  <- mycondition$fp %>% unlist %>% unname

# in parameter trafos, replacing "init_" by "" is not a problem, but they also appear in observation functions to normalize observations. Therefore, duplicate inits, once keeping init_ in the name, but filling both duplicates with the same value
init_ind <- parnames %>% str_detect("^init_")
init_names <- parnames[init_ind]
parnames <- parnames %>% str_replace_all("init_", "")
pareqns  <- pareqns  %>% str_replace_all("init_", "")
init_eqns <- pareqns[init_ind]

parnames <- c(parnames, init_names)
pareqns <- c(pareqns, init_eqns)


# compartment names are somehow already replaced by their values not very elegant, hardcoded and could result in problems for other models
parnames[1:length(comp)] <- comp

trafo_cond <-  pareqns %>%
  setNames(parnames) %>% 
  insert("x~exp(log(10)*x)", x = getSymbols(mytrafo[[i]]))

p <- P(trafo_cond, condition = condname, modelname = paste0("ar_p_", condname))

pouter_values <- mycondition$pNum  %>% unlist %>% unname %>% `attr<-`("dim", NULL)
pouter_names <- mycondition$p  %>% unlist %>% unname

pars <- pouter_values %>% setNames(pouter_names)
```

```{r}
mycondition[str_detect(names(mycondition), "^t")] %>% map(unlist) # time
mycondition[str_detect(names(mycondition), "^y")] %>% map(unlist) #%>% names
```

```{r data cond}
timesD <- mycondition$tExp %>% unlist() %>% unname()
yExp <- mycondition$yExp

yExp <- yExp %>% `colnames<-`(y)
yExp[is.nan(yExp)] <- NA

data <- data.frame(time = timesD, sigma = NA, condition = condname, yExp) %>% 
  gather(name, value, -time, -sigma, -condition) %>% 
  as.data.frame() %>% 
  as.datalist()
```




